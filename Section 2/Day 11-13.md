# Policies & rules

`Defender for Ofice 365 P2` which is included in `Microsoft 365 E5 license` give you the capability to access and modify the following and more:

- **Safe Links**: Scans and rewrites URLs
- **Safe Attachments**: Detonates, opends and test unknown attachments before delivery
- **Anti-Phishing Policies**: Uses machine learning to detect impersonation and spoofing

> To create policies, login to the [Microsoft Defender XDR](https://security.microsoft.com/) portal with you test user account. You can find ploicies under `Email & collaboration -> Policies & rules -> Threat policies`

## Safe Links policies

Safe links protects users by re-writing URLs in emails and scan them in real-time. If a user clicks on a suspicious link even days after the email was delivered, Safe Links can help block the connection because it doe scan for the following:

- URLs in email messages
- Links in Microsoft Teams or Office
- Redirection attempts and embedded links

If a user clicks on something suspicious, Defender will intercept the request, scan it, and then either allow of deny the connection based on the reputation.

### Create a Safe Links policy

Before we create our policy, let's perform a test to ensure that the policy that we will create later works accordingly.

- Send an email from an external account to our test account. (cyberlearner500@gmail.com -> cyberlearner@cyberlearner.onmicrosoft.com) with a link. 
	![alt text](images\image-4.png)		
- In in the received email we can see the link is google.com. That's normal because the Safe Links policy is not created yet.
    ![alt text](images\image-5.png)
- Now let's create a policy, go to  `Microsoft XDR Policies & rules -> Threat policies -> Safe Links -> Create` 
	![alt text](images\image-6.png)
- Add your test user's domain and other information as shown in the screenshots
	![alt text](images\image-7.png)
	![alt text](images\image-8.png)
	![alt text](images\image-9.png)
	![alt text](images\image-10.png)
	![alt text](images\image-11.png)

- Now let's send another email to our test account and see if the URL rewrites
	 ![alt text](images\image-12.png)
- Our policy didn't work because we have to wait for the newly created policy to take an effect for a couple of minutes
	![alt text](images\image-13.png)
- Checked again and it still did not work. So Checked the policy setting's again and **Do not rewrite URLs, do checks via Safe Links API only** setting was enabled by default. Edit the settings and uncheck this option and Save.
	![alt text](images\image-14.png)
    ![alt text](images\image-15.png)
- Send test email again after a couple of minutes and now it works, as you can see a SafeLink at the bottom left corner.
	![alt text](images\image-16.png)

## Anti-Phishing Policies
Helps detects impersonation attempts and spoofing. It uses Machine Learning and user defined rules to detect the following:
- Emails pretending to come from trusted domains or users
- Spoofed display names or reply-to addresses
- Lookalike domain (micros0ft.com vs microsoft.com)

If a personation attempt is detected the email is either quarantined or redirected based on the policy settings.

### Create Anti-Phishing Policy

- Go to Microsoft Defender XDR, `Email & collaboration -> Policies & rules -> Threat policies ->  Anti-phishing -> click Create`. Configure the policy as follows:
![alt text](images\image-17.png)
- Add domain of your tenant
![alt text](images\image-18.png)
- For the next setting leave the **Phishing  email threshold** to Standard
- Check **Enable users to protect (0/350)** and add user(s) that require high protection. You might might to include Executives or any high value target (VIPs) here as we do not want them to be impersonated. This can also include people from financial department to avoid the risk of fraud. Click on **Mange 0 sender(s)** and add important users from your tenant to enable impersonation protection. Then Submit to create the policy. 
![alt text](images\image-19.png)
- Enable other settings
![alt text](images\image-20.png)
- Select appropriate actions if impersonation is detected
![alt text](images\image-21.png)
![alt text](images\image-22.png)


## Configuration analyzer
Helps you identify issues in your current policy configuration and helps you improve your policies for better security.


### External email tagging
- In Configuration analyzer, Select "Change false to true" policy and to enable External email tagging  on emails received outside your tenant.
![alt text](<images\image-2.png>)
- Sent an email from an external tenant. We can see the email is tagged as `External`  
![alt text](images\image-3.png)